# 需要在Automation里设置一个variables，变量名称也叫vmNames
# vmNames里面的虚拟机名称用分号(;)做分隔符

$vmNames = Get-AutomationVariable -Name "vmNames"
Write-Output $vmNames

# Convert the semicolon-separated list of VM names into an array
$vmNameArray = $vmNames -split ";"

# Authenticate to Azure using Managed Identity
try {
    "Logging in to Azure using Managed Identity..."
    Connect-AzAccount -Identity
}
catch {
    $ErrorMessage = "Could not authenticate to Azure using Managed Identity. " + $_
    throw $ErrorMessage
}

# 获取当前 UTC 时间并设置 Kind 属性为 Utc
$currentUtcTime = [DateTime]::UtcNow

# 将 UTC 时间转换为北京时间（UTC+8）
$beijingTimeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("China Standard Time")
$currentBeijingTime = [System.TimeZoneInfo]::ConvertTimeFromUtc($currentUtcTime, $beijingTimeZone)

# 检查当前是否是工作日（周一到周五）
$today = $currentBeijingTime.DayOfWeek
if ($today -ge [System.DayOfWeek]::Monday -and $today -le [System.DayOfWeek]::Friday) {
    foreach ($vmName in $vmNameArray) {
        $vm = Get-AzVM -Name $vmName -Status
        if ($vm) {
            try {
                Start-AzVM -Name $vmName -ResourceGroupName $vm.ResourceGroupName -NoWait
                Write-Output "Starting VM: $vmName"
            }
            catch {
                Write-Output "Failed to start VM: $vmName. Error: $_"
            }
        } else {
            Write-Output "VM $vmName not found."
        }
    }
} else {
    Write-Output "Today is not a weekday. No action taken."
}
